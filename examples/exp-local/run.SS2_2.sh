#!/bin/bash 

rm -rf "run.dpp-local-nc32_ss2-11.warmup.cfg"

job0_0=$(sbatch --job-name="info.before.dpp-local-nc32_ss2-11.warmup.cfg" -w superserver2 -n 1 collect-info.before.sh "run.dpp-local-nc32_ss2-11.warmup.cfg" | awk '{{print $NF}}')
job0_1=$(sbatch --job-name="dpp-local-nc32_ss2-11.warmup.cfg" -w superserver2 -n 32 --dependency=afterany:$job0_0 --wrap="(sh measure_hardware.sh run.dpp-local-nc32_ss2-11.warmup.cfg && perf stat -e power/energy-pkg/,power/energy-ram/ haddock3 'dpp-local-nc32_ss2-11.warmup.cfg' > run.dpp-local-nc32_ss2-11.warmup.cfg.info/haddock.output.log) > run.dpp-local-nc32_ss2-11.warmup.cfg.info/perf_stat.txt 2>&1" | awk '{{print $NF}}')
job0_2=$(sbatch --job-name="info.after.dpp-local-nc32_ss2-11.warmup.cfg" -w superserver2 -n 1 --dependency=afterany:$job0_1 collect-info.after.sh "run.dpp-local-nc32_ss2-11.warmup.cfg" | awk '{{print $NF}}')
job1_0=$(sbatch --job-name="info.before.daa-local-nc32_ss2-12.cfg" -w superserver2 -n 1 --dependency=afterany:$job0_2 collect-info.before.sh "run.daa-local-nc32_ss2-12.cfg" | awk '{{print $NF}}')
job1_1=$(sbatch --job-name="daa-local-nc32_ss2-12.cfg" -w superserver2 -n 32 --dependency=afterany:$job1_0 --wrap="(sh measure_hardware.sh run.daa-local-nc32_ss2-12.cfg && perf stat -e power/energy-pkg/,power/energy-ram/ haddock3 'daa-local-nc32_ss2-12.cfg' > run.daa-local-nc32_ss2-12.cfg.info/haddock.output.log) > run.daa-local-nc32_ss2-12.cfg.info/perf_stat.txt 2>&1" | awk '{{print $NF}}')
job1_2=$(sbatch --job-name="info.after.daa-local-nc32_ss2-12.cfg" -w superserver2 -n 1 --dependency=afterany:$job1_1 collect-info.after.sh "run.daa-local-nc32_ss2-12.cfg" | awk '{{print $NF}}')
job2_0=$(sbatch --job-name="info.before.daa-local-nc16_ss2-13.cfg" -w superserver2 -n 1 --dependency=afterany:$job0_2:$job1_2 collect-info.before.sh "run.daa-local-nc16_ss2-13.cfg" | awk '{{print $NF}}')
job2_1=$(sbatch --job-name="daa-local-nc16_ss2-13.cfg" -w superserver2 -n 16 --dependency=afterany:$job2_0 --wrap="(sh measure_hardware.sh run.daa-local-nc16_ss2-13.cfg && perf stat -e power/energy-pkg/,power/energy-ram/ haddock3 'daa-local-nc16_ss2-13.cfg' > run.daa-local-nc16_ss2-13.cfg.info/haddock.output.log) > run.daa-local-nc16_ss2-13.cfg.info/perf_stat.txt 2>&1" | awk '{{print $NF}}')
job2_2=$(sbatch --job-name="info.after.daa-local-nc16_ss2-13.cfg" -w superserver2 -n 1 --dependency=afterany:$job2_1 collect-info.after.sh "run.daa-local-nc16_ss2-13.cfg" | awk '{{print $NF}}')
job3_0=$(sbatch --job-name="info.before.daa-local-nc16_ss2-12.cfg" -w superserver2 -n 1 --dependency=afterany:$job0_2:$job1_2:$job2_2 collect-info.before.sh "run.daa-local-nc16_ss2-12.cfg" | awk '{{print $NF}}')
job3_1=$(sbatch --job-name="daa-local-nc16_ss2-12.cfg" -w superserver2 -n 16 --dependency=afterany:$job3_0 --wrap="(sh measure_hardware.sh run.daa-local-nc16_ss2-12.cfg && perf stat -e power/energy-pkg/,power/energy-ram/ haddock3 'daa-local-nc16_ss2-12.cfg' > run.daa-local-nc16_ss2-12.cfg.info/haddock.output.log) > run.daa-local-nc16_ss2-12.cfg.info/perf_stat.txt 2>&1" | awk '{{print $NF}}')
job3_2=$(sbatch --job-name="info.after.daa-local-nc16_ss2-12.cfg" -w superserver2 -n 1 --dependency=afterany:$job3_1 collect-info.after.sh "run.daa-local-nc16_ss2-12.cfg" | awk '{{print $NF}}')
job4_0=$(sbatch --job-name="info.before.daa-local-nc16_ss2-11.cfg" -w superserver2 -n 1 --dependency=afterany:$job0_2:$job1_2:$job2_2:$job3_2 collect-info.before.sh "run.daa-local-nc16_ss2-11.cfg" | awk '{{print $NF}}')
job4_1=$(sbatch --job-name="daa-local-nc16_ss2-11.cfg" -w superserver2 -n 16 --dependency=afterany:$job4_0 --wrap="(sh measure_hardware.sh run.daa-local-nc16_ss2-11.cfg && perf stat -e power/energy-pkg/,power/energy-ram/ haddock3 'daa-local-nc16_ss2-11.cfg' > run.daa-local-nc16_ss2-11.cfg.info/haddock.output.log) > run.daa-local-nc16_ss2-11.cfg.info/perf_stat.txt 2>&1" | awk '{{print $NF}}')
job4_2=$(sbatch --job-name="info.after.daa-local-nc16_ss2-11.cfg" -w superserver2 -n 1 --dependency=afterany:$job4_1 collect-info.after.sh "run.daa-local-nc16_ss2-11.cfg" | awk '{{print $NF}}')
job5_0=$(sbatch --job-name="info.before.daa-local-nc32_ss2-13.cfg" -w superserver2 -n 1 --dependency=afterany:$job0_2:$job1_2:$job2_2:$job3_2:$job4_2 collect-info.before.sh "run.daa-local-nc32_ss2-13.cfg" | awk '{{print $NF}}')
job5_1=$(sbatch --job-name="daa-local-nc32_ss2-13.cfg" -w superserver2 -n 32 --dependency=afterany:$job5_0 --wrap="(sh measure_hardware.sh run.daa-local-nc32_ss2-13.cfg && perf stat -e power/energy-pkg/,power/energy-ram/ haddock3 'daa-local-nc32_ss2-13.cfg' > run.daa-local-nc32_ss2-13.cfg.info/haddock.output.log) > run.daa-local-nc32_ss2-13.cfg.info/perf_stat.txt 2>&1" | awk '{{print $NF}}')
job5_2=$(sbatch --job-name="info.after.daa-local-nc32_ss2-13.cfg" -w superserver2 -n 1 --dependency=afterany:$job5_1 collect-info.after.sh "run.daa-local-nc32_ss2-13.cfg" | awk '{{print $NF}}')
job6_0=$(sbatch --job-name="info.before.daa-local-nc32_ss2-11.cfg" -w superserver2 -n 1 --dependency=afterany:$job0_2:$job1_2:$job2_2:$job3_2:$job4_2:$job5_2 collect-info.before.sh "run.daa-local-nc32_ss2-11.cfg" | awk '{{print $NF}}')
job6_1=$(sbatch --job-name="daa-local-nc32_ss2-11.cfg" -w superserver2 -n 32 --dependency=afterany:$job6_0 --wrap="(sh measure_hardware.sh run.daa-local-nc32_ss2-11.cfg && perf stat -e power/energy-pkg/,power/energy-ram/ haddock3 'daa-local-nc32_ss2-11.cfg' > run.daa-local-nc32_ss2-11.cfg.info/haddock.output.log) > run.daa-local-nc32_ss2-11.cfg.info/perf_stat.txt 2>&1" | awk '{{print $NF}}')
job6_2=$(sbatch --job-name="info.after.daa-local-nc32_ss2-11.cfg" -w superserver2 -n 1 --dependency=afterany:$job6_1 collect-info.after.sh "run.daa-local-nc32_ss2-11.cfg" | awk '{{print $NF}}')
cat > check.SS2_2.sh << EOF
#!/bin/bash
echo $job1_1,$job2_1,$job3_1,$job4_1,$job5_1,$job6_1
sacct -o jobid,jobname%60,cluster,Node%24,state,start,end,ConsumedEnergy,AveRSS,AveDiskRead,AveDiskWrite,AveVMSize,SystemCPU,UserCPU,AveCPU,elapsed,NCPUS,Account%100,AdminComment%100,AllocCPUS%100,AllocNodes%100,AllocTRES%100,AssocID%100,AveCPUFreq%100,AvePages%100,BlockID%100,Comment%100,Constraints%100,ConsumedEnergyRaw%100,Container%100,CPUTime%100,CPUTimeRAW%100,DBIndex%100,DerivedExitCode%100,ElapsedRaw%100,Eligible%100,ExitCode%100,FailedNode%100,Flags%100,GID%100,Group%100,JobIDRaw%100,Layout%100,MaxDiskRead%100,MaxDiskReadNode%100,MaxDiskReadTask%100,MaxDiskWrite%100,MaxDiskWriteNode%100,MaxDiskWriteTask%100,MaxPages%100,MaxPagesNode%100,MaxPagesTask%100,MaxRSS%100,MaxRSSNode%100,MaxRSSTask%100,MaxVMSize%100,MaxVMSizeNode%100,MaxVMSizeTask%100,McsLabel%100,MinCPU%100,MinCPUNode%100,MinCPUTask%100,NNodes%100,NodeList%100,NTasks%100,Partition%100,Planned%100,PlannedCPU%100,PlannedCPURAW%100,Priority%100,QOS%100,QOSRAW%100,Reason%100,ReqCPUFreq%100,ReqCPUFreqGov%100,ReqCPUFreqMax%100,ReqCPUFreqMin%100,ReqCPUS%100,ReqMem%100,ReqNodes%100,ReqTRES%100,Reservation%100,ReservationId%100,Suspended%100,SystemComment%100,Timelimit%100,TimelimitRaw%100,TotalCPU%100,TRESUsageInAve%100,TRESUsageInMax%100,TRESUsageInMaxNode%100,TRESUsageInMaxTask%100,TRESUsageInMin%100,TRESUsageInMinNode%100,TRESUsageInMinTask%100,TRESUsageInTot%100,TRESUsageOutAve%100,TRESUsageOutMax%100,TRESUsageOutMaxNode%100,TRESUsageOutMaxTask%100,TRESUsageOutMin%100,TRESUsageOutMinNode%100,TRESUsageOutMinTask%100,TRESUsageOutTot%100,UID%100,User%100,WCKey%100,WCKeyID%100,WorkDir%100,Submit%100,SubmitLine%1000 -j $job1_1,$job2_1,$job3_1,$job4_1,$job5_1,$job6_1 > data.SS2_2.txt
cat data.SS2_2.txt
EOF

cat > check.full.SS2_2.sh << EOF
#!/bin/bash
echo $job0_0,$job0_1,$job0_2,$job1_0,$job1_1,$job1_2,$job2_0,$job2_1,$job2_2,$job3_0,$job3_1,$job3_2,$job4_0,$job4_1,$job4_2,$job5_0,$job5_1,$job5_2,$job6_0,$job6_1,$job6_2
sacct -o jobid,jobname%60,cluster,Node%24,state,start,end,ConsumedEnergy,AveRSS,AveDiskRead,AveDiskWrite,AveVMSize,SystemCPU,UserCPU,AveCPU,elapsed,NCPUS,Account%100,AdminComment%100,AllocCPUS%100,AllocNodes%100,AllocTRES%100,AssocID%100,AveCPUFreq%100,AvePages%100,BlockID%100,Comment%100,Constraints%100,ConsumedEnergyRaw%100,Container%100,CPUTime%100,CPUTimeRAW%100,DBIndex%100,DerivedExitCode%100,ElapsedRaw%100,Eligible%100,ExitCode%100,FailedNode%100,Flags%100,GID%100,Group%100,JobIDRaw%100,Layout%100,MaxDiskRead%100,MaxDiskReadNode%100,MaxDiskReadTask%100,MaxDiskWrite%100,MaxDiskWriteNode%100,MaxDiskWriteTask%100,MaxPages%100,MaxPagesNode%100,MaxPagesTask%100,MaxRSS%100,MaxRSSNode%100,MaxRSSTask%100,MaxVMSize%100,MaxVMSizeNode%100,MaxVMSizeTask%100,McsLabel%100,MinCPU%100,MinCPUNode%100,MinCPUTask%100,NNodes%100,NodeList%100,NTasks%100,Partition%100,Planned%100,PlannedCPU%100,PlannedCPURAW%100,Priority%100,QOS%100,QOSRAW%100,Reason%100,ReqCPUFreq%100,ReqCPUFreqGov%100,ReqCPUFreqMax%100,ReqCPUFreqMin%100,ReqCPUS%100,ReqMem%100,ReqNodes%100,ReqTRES%100,Reservation%100,ReservationId%100,Suspended%100,SystemComment%100,Timelimit%100,TimelimitRaw%100,TotalCPU%100,TRESUsageInAve%100,TRESUsageInMax%100,TRESUsageInMaxNode%100,TRESUsageInMaxTask%100,TRESUsageInMin%100,TRESUsageInMinNode%100,TRESUsageInMinTask%100,TRESUsageInTot%100,TRESUsageOutAve%100,TRESUsageOutMax%100,TRESUsageOutMaxNode%100,TRESUsageOutMaxTask%100,TRESUsageOutMin%100,TRESUsageOutMinNode%100,TRESUsageOutMinTask%100,TRESUsageOutTot%100,UID%100,User%100,WCKey%100,WCKeyID%100,WorkDir%100,Submit%100,SubmitLine%1000 -j $job0_0,$job0_1,$job0_2,$job1_0,$job1_1,$job1_2,$job2_0,$job2_1,$job2_2,$job3_0,$job3_1,$job3_2,$job4_0,$job4_1,$job4_2,$job5_0,$job5_1,$job5_2,$job6_0,$job6_1,$job6_2 > data.full.SS2_2.txt
cat data.full.SS2_2.txt
EOF
